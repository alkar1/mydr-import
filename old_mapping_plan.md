# Plan Mapowania Danych V6: Etap1 do Docelowych Plików CSV

Ten dokument opisuje plan mapowania danych z plików źródłowych (głównie w katalogu `etap1`) do docelowych formatów CSV zdefiniowanych w katalogu `definitions`. Ten plan rozszerza i udoskonala poprzedni `mapping_plan.md`.

## Zaktualizowany Diagram Przepływu Danych

```mermaid
graph TD
    subgraph Pliki Źródłowe (etap1)
        A[gabinet.visit.txt]
        B[gabinet.patient.txt]
        C[gabinet.person.txt]
        D[gabinet.address.txt]
        E[gabinet.patientpermanentdrug.txt]
        F[gabinet.recognition.txt]
        G[gabinet.icd10.txt]
        H[gabinet.medicalprocedure.txt]
        I[gabinet.icd9.txt]
        J[gabinet.custodian.txt]
        K[gabinet.sickleave.txt]
        L[auth.user.txt]
        M[gabinet.profile.txt]
        N[gabinet.specialty.txt]
        O[gabinet.ver.txt (Słownik Leków)]
        P[gabinet.visitnotes.txt]
        Q[gabinet.insurancedocuments.txt]
        R[gabinet.vaccination.txt]
    end

    subgraph Przetwarzanie i Mapowanie Danych
        S{Ekstrakcja i Mapowanie Danych}
        A --> S
        B --> S
        C --> S
        D --> S
        E --> S
        F --> S
        G --> S
        H --> S
        I --> S
        J --> S
        K --> S
        L --> S
        M --> S
        N --> S
        O --> S
        P --> S
        Q --> S
        R --> S
    end

    subgraph Docelowe Pliki CSV (etap2)
        T[wizyty.csv]
        U[karty_wizyt.csv]
        V[pacjenci.csv]
        W[pracownicy.csv]
        X[stale_leki_pacjenta.csv]
        Y[deklaracje_poz.csv]
        Z[jednostki.csv]
        AA[dokumenty_uprawniajace.csv]
        AB[szczepienia.csv]
    end

    S --> T
    S --> U
    S --> V
    S --> W
    S --> X
    S --> Y
    S --> Z
    S --> AA
    S --> AB
```

## Proponowane Mapowanie Pól

*(Uwaga: Mapowania opierają się na analizie definicji i próbek plików źródłowych. Nazwy pól źródłowych i ich istnienie wymagają ostatecznej weryfikacji podczas implementacji. Wartości domyślne powinny być stosowane tam, gdzie brakuje danych źródłowych lub mapowanie nie jest możliwe, zgodnie z definicjami docelowymi.)*

### 1. Dla `wizyty.csv` (Aktualizacje na podstawie definicji)

| Pole Docelowe                    | Pole/Plik(i) Źródłowe                                    | Logika Transformacji                                                                                                                               | Uwagi                                                                                                                                                           |
| :------------------------------- | :------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `InstalacjaId`                   | *Niedostępne bezpośrednio*                               | Ustaw na `null`.                                                                                                                                   | Zgodnie z definicją.                                                                                                                                            |
| `IdImport`                       | `id` z `gabinet.visit.txt`                               | Mapowanie bezpośrednie.                                                                                                                            | Wymagane. Klucz główny wizyty.                                                                                                                                  |
| `JednostkaId`                    | *Niedostępne bezpośrednio*                               | Ustaw na `DEFAULT_EMPTY` (""). ID systemu docelowego.                                                                                              | Wymaga `JednostkaIdImport`.                                                                                                                                     |
| `JednostkaIdImport`              | `office` z `gabinet.visit.txt`                           | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub `JednostkaId`). ID jednostki/gabinetu.                                                                                                            |
| `PacjentId`                      | *Niedostępne bezpośrednio*                               | Ustaw na `DEFAULT_EMPTY` (""). ID systemu docelowego.                                                                                              | Wymaga `PacjentIdImport` lub `PacjentPesel`.                                                                                                                    |
| `PacjentIdImport`                | `patient` z `gabinet.visit.txt`                          | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub `PacjentId` / `PacjentPesel`). ID pacjenta.                                                                                                       |
| `PacjentPesel`                   | `pesel` z `gabinet.patient.txt`                          | Połącz `gabinet.visit.txt` po `patient` z `gabinet.patient.txt` po `id`.                                                                           | Wymagane (lub `PacjentId` / `PacjentIdImport`).                                                                                                                 |
| `PracownikId`                    | *Niedostępne bezpośrednio*                               | Ustaw na `DEFAULT_EMPTY` (""). ID systemu docelowego.                                                                                              | Wymaga `PracownikIdImport` / `PracownikNPWZ` / `PracownikPesel` / `ZasobIdImport`.                                                                             |
| `PracownikIdImport`              | `doctor` z `gabinet.visit.txt`                           | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub inne identyfikatory Pracownik/Zasob). ID lekarza/pracownika.                                                                                      |
| `ZasobIdImport`                  | *Niedostępne bezpośrednio*                               | Ustaw na `DEFAULT_EMPTY` ("").                                                                                                                      | Wymagane (lub inne identyfikatory Pracownik).                                                                                                                   |
| `PracownikNPWZ`                  | `pwz` z `gabinet.person.txt`                             | Połącz `gabinet.visit.txt` po `doctor` z `gabinet.person.txt` po `id`.                                                                             | Wymagane (lub inne identyfikatory Pracownik/Zasob). Sprawdź format.                                                                                             |
| `PracownikPesel`                 | `pesel` z `gabinet.person.txt`                           | Połącz `gabinet.visit.txt` po `doctor` z `gabinet.person.txt` po `id`.                                                                             | Wymagane (lub inne identyfikatory Pracownik/Zasob).                                                                                                             |
| `PlatnikIdImportu`               | *Niedostępne bezpośrednio*                               | Ustaw na `DEFAULT_EMPTY` ("").                                                                                                                      | Kod nie implementuje logiki warunkowej opartej na NFZ.                                                                                                          |
| `JednostkaRozliczeniowaId`       | *Niedostępne bezpośrednio*                               | Ustaw na `DEFAULT_EMPTY` ("").                                                                                                                      | Kod nie implementuje logiki warunkowej opartej na NFZ.                                                                                                          |
| `JednostkaRozliczeniowaIdImportu`| *Niedostępne bezpośrednio*                               | Ustaw na `DEFAULT_EMPTY` ("").                                                                                                                      | Kod nie implementuje logiki warunkowej opartej na NFZ.                                                                                                          |
| `DataUtworzenia`                 | `created` z `gabinet.visit.txt`                          | Użyj znacznika czasu `visit.created`, jeśli dostępny i parsowalny (format ISO np. 'RRRR-MM-DDTHH:MM:SS.ffffff'), w przeciwnym razie użyj znacznika czasu wykonania skryptu. Zapewnij format `RRRR-MM-DD GG:MM:SS`. | Kod priorytetyzuje `visit.created`.                                                                                                                             |
| `DataOd`                         | `date`, `timeFrom` z `gabinet.visit.txt`                 | Połącz datę i czas. Zapewnij format `RRRR-MM-DD GG:MM:SS`.                                                                                         | Wymagane.                                                                                                                                                       |
| `DataDo`                         | `date`, `timeTo` z `gabinet.visit.txt`                   | Połącz datę i czas. Zapewnij format `RRRR-MM-DD GG:MM:SS`. Obsłuż potencjalne wartości null/brakujący czas.                                         | Opcjonalne (Ostrzeżenie, jeśli puste).                                                                                                                          |
| `CzasOd`                         | `timeFrom` z `gabinet.visit.txt`                         | Użyj tylko, jeśli `DataOd` nie zawiera czasu (mało prawdopodobne na podstawie formatu źródłowego).                                                | Zazwyczaj zbędne, jeśli `DataOd` ma czas.                                                                                                                       |
| `CzasDo`                         | `timeTo` z `gabinet.visit.txt`                           | Użyj tylko, jeśli `DataDo` nie zawiera czasu (mało prawdopodobne na podstawie formatu źródłowego).                                                | Zazwyczaj zbędne, jeśli `DataDo` ma czas.                                                                                                                       |
| `Status`                         | `state` z `gabinet.visit.txt`                            | Zmapuj źródłowy `state` (np. "Anulowana", "Archiwalna") na kody docelowe: 1=Zaplanowane, 2=W trakcie, 3=Zrealizowane, 4=Rozliczane, 9=Odwołane. Zmapuj "Archiwalna" na '3' na razie. Zbierz unikalne wartości źródłowe podczas przetwarzania. | Wymagane. Potrzebuje jawnych reguł mapowania dla wartości źródłowych.                                                                                           |
| `NFZ`                            | `visit_kind` z `gabinet.visit.txt`                       | Zmapuj na '1', jeśli `visit_kind` zawiera 'NFZ', w przeciwnym razie '0'.                                                                           | Wymagane.                                                                                                                                                       |
| `NieRozliczaj`                   | *Niedostępne bezpośrednio*                               | Domyślnie '0'.                                                                                                                                     |                                                                                                                                                                 |
| `Dodatkowy`                      | *Niedostępne bezpośrednio*                               | Domyślnie '0'.                                                                                                                                     |                                                                                                                                                                 |
| `Komentarz`                      | *Niedostępne bezpośrednio*                               | Ustaw na pusty ciąg znaków `""`.                                                                                                                   | Pole `visit.note` zostało przeniesione do `karty_wizyt.Zalecenia`. To pole jest celowo pozostawione puste.                                                      |
| `TrybPrzyjecia`                  | `reception_mode_choice` z `gabinet.visit.txt`            | Bezpośrednie mapowanie wartości `reception_mode_choice` ze źródła. Jeśli wartość źródłowa jest pusta lub null, domyślnie '5'.                     | Wymagane. Pole źródłowe potwierdzone. Użyj wartości źródłowej bezpośrednio, jeśli obecna, w przeciwnym razie domyślnie '5'. Zakłada, że kody źródłowe pasują do kodów docelowych (4, 13, 14, 2, 5, 7). |
| `TrybDalszegoLeczenia`           | *Niedostępne bezpośrednio*                               | Przypisz domyślną lub określ źródło. Zmapuj na kody docelowe (1-5), jeśli źródło zostanie znalezione. Domyślnie `null`.                             |                                                                                                                                                                 |
| `TypWizyty`                      | `visittype`? (Nie widziano w próbce `visit.txt`)         | Zmapuj wartość źródłową (jeśli istnieje) na kody docelowe (1-9). Przypisz domyślną lub zbadaj dalej. Domyślnie `null`.                               | Pole źródłowe wymaga potwierdzenia.                                                                                                                             |
| `KodSwiadczeniaNFZ`              | *Niedostępne bezpośrednio*                               | Wymaga logiki mapowania opartej na typie wizyty/procedurach, jeśli NFZ='1'. Domyślnie `null`.                                                     |                                                                                                                                                                 |
| `KodUprawnieniaPacjenta`         | `rights` z `gabinet.patient.txt`                         | Połącz `visit` z `patient`, aby uzyskać kod uprawnień. Zmapuj 'X' na pusty ciąg znaków. Sprawdź kody źródłowe z listą docelową (24A, ..., WP). Domyślnie `null`. | Użyj kodu tekstowego ze źródła.                                                                                                                                 |
| `ProceduryICD9`                  | `icd9` z `gabinet.medicalprocedure.txt` przez ID `visit` | Zmapuj `visit.id` -> `medicalprocedure.visit` -> `medicalprocedure.icd9` (ID) -> `icd9.id` -> `icd9.code`. Agreguj wiele kodów, oddzielonych przecinkami. | Wymaga logiki łączenia.                                                                                                                                         |
| `RozpoznaniaICD10`               | `icd10` z `gabinet.recognition.txt` przez ID `visit`     | Zmapuj `visit.id` -> `recognition.visit` -> `recognition.icd10` (ID) -> `icd10.id` -> `icd10.code`. Agreguj wiele kodów, oddzielonych przecinkami.    | Wymaga logiki łączenia. Pierwszy kod jest główny.                                                                                                               |
| `DokumentSkierowujacyIdImportu`  | *Niedostępne bezpośrednio*                               | Określ źródło, jeśli skierowania są powiązane z wizytami. Domyślnie `null`.                                                                         | Mechanizm powiązania wymaga wyjaśnienia.                                                                                                                       |

### 2. Dla `karty_wizyt.csv` (Aktualizacje na podstawie definicji)

| Pole Docelowe                    | Pole/Plik(i) Źródłowe                                    | Logika Transformacji                                                                                                | Uwagi                                                                                                                               |
| :------------------------------- | :------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------- |
| `InstalacjaId`                   | *Niedostępne bezpośrednio*                               | Ustaw na `null`.                                                                                                      |                                                                                                                                     |
| `IdImport`                       | `id` z `gabinet.visit.txt`                               | Konwertuj `visit.id` na ciąg znaków.                                                                                | **Typ to Tekst**. Łączy z wizytą. Opcjonalne (Ostrzeżenie, jeśli puste).                                                             |
| `IdImportPrefix`                 | *Stała*                                                  | Ustaw stałą wartość (np. 'VISITCARD').                                                                              | Sprawdź, czy wymagane przez narzędzie importu.                                                                                      |
| `DataWystawienia`                | `date` z `gabinet.visit.txt`                             | Użyj daty wizyty. Zapewnij format `RRRR-MM-DD GG:MM:SS` (dodaj domyślny czas, jeśli potrzebny).                      | Opcjonalne (Ostrzeżenie, jeśli puste).                                                                                              |
| `DataAutoryzacji`                | `last_revision`? z `gabinet.visit.txt`                   | Użyj znacznika czasu `visit.last_revision` lub `DataWystawienia` / daty importu jako domyślnej. Zapewnij format `RRRR-MM-DD GG:MM:SS`. |                                                                                                                                     |
| `PracownikWystawiajacyIdImport`  | `doctor` z `gabinet.visit.txt`                           | Użyj tego ID.                                                                                                       | Wymagane (lub `PracownikWystawiajacyNpwz`).                                                                                         |
| `PracownikWystawiajacyNpwz`      | `pwz` z `gabinet.person.txt`                             | Połącz `visit.doctor` z `person.id`, aby uzyskać `pwz`.                                                             | Wymagane (lub `PracownikWystawiajacyIdImport`).                                                                                     |
| `PracownikWystawiajacyPesel`     | `pesel` z `gabinet.person.txt`                           | Połącz `visit.doctor` z `person.id`, aby uzyskać `pesel`.                                                           | Opcjonalny identyfikator.                                                                                                           |
| `WizytaIdImport`                 | `id` z `gabinet.visit.txt`                               | Mapowanie bezpośrednie (liczba całkowita).                                                                          | Wymagane. Łączy kartę z powrotem do wizyty.                                                                                         |
| `Wywiad`                         | `interview` z `gabinet.visit.txt`                        | Mapowanie bezpośrednie.                                                                                             |                                                                                                                                     |
| `BadaniePrzedmiotowe`            | `examination` z `gabinet.visit.txt`                      | Mapowanie bezpośrednie.                                                                                             |                                                                                                                                     |
| `PrzyjmowaneLeki`                | *Niedostępne bezpośrednio*                               | Ustaw na `DEFAULT_EMPTY` ("").                                                                                                                      | Logika niezaimplementowana; pole jest tymczasowo puste.                                                                                                         |
| `PrzebiegLeczenia`               | Agreguj z `gabinet.recipe.txt`, `gabinet.recipedrug.txt` | Połącz `visit.id` z `recipe.visit`. Agreguj informacje o przepisanych lekach, wyszukując nazwę leku w `gabinet.ver.txt` po ID. | Pole jest dynamicznie budowane z danych o receptach powiązanych z wizytą. Informacje o skierowaniach zostały usunięte z powodu braku wiarygodnego opisu. |
| `Zalecenia`                      | `recommendation` z `gabinet.visit.txt` ORAZ `note` z `gabinet.visit.txt` | Połącz `visit.recommendation` (zalecenia ogólne) z `visit.note` (które często zawiera szczegóły leków). Połącz nową linią, jeśli oba istnieją. | Logika zmieniona: `visit.note` (leki) jest teraz częścią `Zaleceń`, a nie `Inne`.                                                     |
| `Zabiegi`                        | Mapuj z `ProceduryICD9`?                                 | Potencjalnie wymień kody ICD9 lub zmapuj konkretne kody procedur, jeśli dostępne.                                  |                                                                                                                                     |
| `Inne`                           | `note` z `gabinet.visitnotes.txt`                        | Agreguj tylko notatki z `visitnotes.txt` powiązane przez `visitnotes.visit`.                                        | Logika zmieniona: Pole `Inne` zawiera teraz tylko notatki systemowe/dodatkowe, a nie informacje o lekach z `visit.note`.             |
| `NiezdolnoscOd`                  | `date_from`? z `gabinet.sickleave.txt`                   | Połącz `visit.id` z `sickleave.visit`? Wymaga zbadania źródła danych zwolnienia lekarskiego i powiązania. Zapewnij format. |                                                                                                                                     |
| `NiezdolnoscDo`                  | `date_to`? z `gabinet.sickleave.txt`                     | Połącz `visit.id` z `sickleave.visit`? Wymaga zbadania źródła danych zwolnienia lekarskiego i powiązania. Zapewnij format. |                                                                                                                                     |
| `RozpoznaniaICD10`               | *Tak samo jak dla `wizyty.csv`*                          | Użyj tej samej logiki mapowania ICD10. Oddzielone przecinkami.                                                      | Użyj tego pola głównie.                                                                                                             |
| `RozpoznanieGlowneICD10`         | *Wyprowadzone z `RozpoznaniaICD10`*                      | Wyodrębnij pierwszy kod z `RozpoznaniaICD10`.                                                                       | Użyj tylko, jeśli `RozpoznaniaICD10` nie jest podane.                                                                               |
| `RozpoznanieWspolistniejaceICD10`| *Wyprowadzone z `RozpoznaniaICD10`*                      | Wyodrębnij kody po pierwszym z `RozpoznaniaICD10`.                                                                  | Użyj tylko, jeśli `RozpoznaniaICD10` nie jest podane.                                                                               |
| `RozpoznanieOpisowe`             | `recognition_description`? z `gabinet.visit.txt` lub inne | Mapuj z pola źródłowego (jeśli istnieje i jest używane przez kod) lub potencjalnie z `visitnotes` lub innego pola. | Należy zweryfikować istnienie i użycie pola `recognition_description` w kodzie. Jeśli nie, określić faktyczne źródło.                 |
| `ProceduryICD9`                  | *Tak samo jak dla `wizyty.csv`*                          | Użyj tej samej logiki mapowania ICD9. Oddzielone przecinkami.                                                       |                                                                                                                                     |

### 3. Dla `pacjenci.csv` (Aktualizacje na podstawie definicji)

| Pole Docelowe                    | Pole/Plik(i) Źródłowe                                                                | Logika Transformacji                                                                                                                               | Uwagi                                                                                                                                                           |
| :------------------------------- | :----------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `InstalacjaId`                   | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`.                                                                                                                                     |                                                                                                                                                                 |
| `IdImport`                       | `id` z `gabinet.patient.txt`                                                         | Mapowanie bezpośrednie.                                                                                                                            | Wymagane. Klucz główny pacjenta.                                                                                                                                |
| `UprawnieniePacjentaId`          | `rights` z `gabinet.patient.txt`                                                     | Zmapuj kod tekstowy źródła (np. 'IB', 'WP', 'X') na docelowy ID numeryczny (1-34). Zmapuj 'X' na `null`.                                             | Wymaga tabeli/logiki mapowania.                                                                                                                                 |
| `RodzajPacjenta`                 | *Niedostępne bezpośrednio*                                                            | Domyślnie 1 (osoba fizyczna).                                                                                                                      |                                                                                                                                                                 |
| `Imie`                           | `name` z `gabinet.patient.txt`                                                       | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub `Nazwisko`/`Pesel`). Sprawdź długość/znaki.                                                                                                       |
| `Nazwisko`                       | `surname` z `gabinet.patient.txt`                                                    | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub `Imie`/`Pesel`). Sprawdź długość/znaki.                                                                                                           |
| `Pesel`                          | `pesel` z `gabinet.patient.txt`                                                      | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub `Imie`/`Nazwisko`). Sprawdź format/sumę kontrolną.                                                                                                 |
| `DataUrodzenia`                  | `birthdate` lub `date_of_birth` z `gabinet.patient.txt`                              | Użyj `birthdate`, jeśli dostępne; w przeciwnym razie użyj `date_of_birth`. Zapewnij format `RRRR-MM-DD GG:MM:SS`. Sprawdź względem PESEL.             | Kod sprawdza oba pola źródłowe.                                                                                                                                 |
| `CzyUmarl`                       | `is_active` z `gabinet.patient.txt`                                                  | Zmapuj `is_active` (boolean): `true` -> '0', `false` -> '1'. Domyślnie '0'.                                                                         | Odwróć logikę z `is_active`.                                                                                                                                    |
| `DataZgonu`                      | `deceased_date`? (Nie widziano w próbce)                                             | Zmapuj datę źródłową, jeśli `CzyUmarl` to '1'. Wymaga potwierdzenia, czy pole istnieje. Domyślnie `null`.                                            |                                                                                                                                                                 |
| `DrugieImie`                     | `second_name` z `gabinet.patient.txt`                                                | Mapowanie bezpośrednie.                                                                                                                            |                                                                                                                                                                 |
| `NazwiskoRodowe`                 | `maiden_name` z `gabinet.patient.txt`                                                | Mapowanie bezpośrednie.                                                                                                                            |                                                                                                                                                                 |
| `ImieOjca`                       | `father_name`? (Nie widziano w próbce)                                               | Mapowanie bezpośrednie, jeśli pole istnieje.                                                                                                       | Wymaga potwierdzenia.                                                                                                                                           |
| `NIP`                            | `employer_nip`? (Nie widziano w próbce)                                              | Mapowanie bezpośrednie, jeśli pole istnieje.                                                                                                       | Wymaga potwierdzenia.                                                                                                                                           |
| `Plec`                           | `sex` z `gabinet.patient.txt`                                                        | Zmapuj wartość źródłową (np. 'Kobieta', 'Mężczyzna') na docelową ('k'/'m'). Sprawdź względem PESEL.                                                  | Wymaga logiki mapowania.                                                                                                                                        |
| `Email`                          | `email` z `gabinet.patient.txt`                                                      | Mapowanie bezpośrednie.                                                                                                                            |                                                                                                                                                                 |
| `Telefon`                        | `telephone` z `gabinet.patient.txt`                                                  | Mapowanie bezpośrednie. Sprawdź format/długość.                                                                                                     |                                                                                                                                                                 |
| `TelefonDodatkowy`               | `second_telephone`? (Nie widziano w próbce)                                          | Mapowanie bezpośrednie, jeśli pole istnieje.                                                                                                       | Wymaga potwierdzenia.                                                                                                                                           |
| `NumerDokumentuTozsamosci`       | `identity_num` z `gabinet.patient.txt`                                               | Mapowanie bezpośrednie.                                                                                                                            | Wymagane, jeśli podano `TypDokumentuTozsamosci`.                                                                                                                |
| `TypDokumentuTozsamosci`         | `identity_type` z `gabinet.patient.txt`                                              | Zmapuj wartość źródłową (np. 'id_card') na kod docelowy (D, T, L, P, K, J, I).                                                                      | Wymaga logiki mapowania.                                                                                                                                        |
| `KrajDokumentuTozsamosciKod`     | `country`? z `gabinet.patient.txt`                                                   | Użyj kodu kraju pacjenta ('PL') lub określ na podstawie kontekstu. Domyślnie 'PL'.                                                                  |                                                                                                                                                                 |
| `NrIdentyfikacyjnyUe`            | *Niedostępne bezpośrednio*                                                            | Pozostaw puste lub przypisz domyślną.                                                                                                              |                                                                                                                                                                 |
| `MiejsceUrodzenia`               | `place_of_birth` z `gabinet.patient.txt`                                             | Mapowanie bezpośrednie.                                                                                                                            |                                                                                                                                                                 |
| `KodOddzialuNFZ`                 | `code` z `gabinet.insurance.txt`                                                     | Połącz `patient.insurance` (z `patient.txt`) z `insurance.id` (z `insurance.txt`), aby uzyskać `insurance.code`.                                   | Poprawiony opis łączenia źródła.                                                                                                                                |
| **Pola Adresowe (`...Zameldowanie`, `...Zamieszkanie`)** | Połącz `patient.registration_address`/`residence_address` z `address.id` | Zmapuj odpowiednie pola (`country`, `province`, `city`, `postal_code`, `street`, `street_number`, `flat_number`) z `gabinet.address.txt`. | Obsłuż brakujące typy adresów (użyj zameldowania, jeśli brakuje korespondencyjnego). Domyślny kraj 'Polska'. Sprawdź format kodu pocztowego. Kody TERYT/Powiat niedostępne. |
| `Uwagi`                          | *Niedostępne bezpośrednio*                                                            | Ustaw na pusty ciąg znaków `""`.                                                                                                                   | Celowo ustawione na puste zgodnie z wymaganiami. Logika agregacji notatek z `patientnote.txt` i `patient.txt` jest zakomentowana w kodzie.                     |
| `Uchodzca`                       | `is_refugee` z `gabinet.patient.txt`                                                 | Zmapuj źródłowy boolean/flagę na '1' (Prawda) lub '0' (Fałsz). Domyślnie '0'.                                                                       |                                                                                                                                                                 |
| `VIP`                            | `vip`? (Nie widziano w próbce)                                                       | Zmapuj źródłowy boolean/flagę (jeśli istnieje) na '1' (Prawda) lub '0' (Fałsz). Domyślnie '0'.                                                     | Wymaga potwierdzenia.                                                                                                                                           |
| `UprawnieniePacjenta`            | `rights` z `gabinet.patient.txt`                                                     | Bezpośrednie mapowanie kodu tekstowego źródła (np. 'IB', 'X'). Zmapuj 'X' na pusty ciąg znaków.                                                      | Kod tekstowy uprawnień.                                                                                                                                         |
| **Pola Opiekuna (`...Opiekuna`)** | Połącz `patient.supervisor` z `custodian.id`                                         | Zmapuj odpowiednie pola (`name`, `surname`, `sex`, `birthdate`, `pesel`, `phone`, `relation`) z `gabinet.custodian.txt`. Pola adresowe prawdopodobnie niedostępne. | Obsłużyć wielu opiekunów? Zmapuj tekst `relation` na ID docelowe (1, 4, 5). Zmapuj `sex`. Adres prawdopodobnie wymaga domyślnych wartości lub pominięcia.          |
| `SprawdzUnikalnoscIdImportu`     | *Nie dotyczy*                                                                        | Ustaw na '1' (Tak).                                                                                                                                | Flaga kontrolna narzędzia importu.                                                                                                                              |
| `SprawdzUnikalnoscPesel`         | *Nie dotyczy*                                                                        | Ustaw na '0' (Nie).                                                                                                                                | Flaga kontrolna narzędzia importu.                                                                                                                              |
| `AktualizujPoPesel`              | *Nie dotyczy*                                                                        | Ustaw na '0' (Nie).                                                                                                                                | Flaga kontrolna narzędzia importu.                                                                                                                              |
| `NumerPacjenta`                  | `user`? z `gabinet.patient.txt`                                                      | Mapuj z pola źródłowego, jeśli reprezentuje numer pacjenta. Wymaga potwierdzenia.                                                                  |                                                                                                                                                                 |

### 4. Dla `pracownicy.csv` (Nowy Plik)

| Pole Docelowe                    | Pole/Plik(i) Źródłowe                                                                | Logika Transformacji                                                                                                                               | Uwagi                                                                                                                                                           |
| :------------------------------- | :----------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `InstalacjaId`                   | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`.                                                                                                                                     |                                                                                                                                                                 |
| `IdImport`                       | `id` z `gabinet.person.txt`                                                          | Mapowanie bezpośrednie.                                                                                                                            | Wymagane. Klucz główny pracownika/osoby.                                                                                                                        |
| `Imie`                           | `first_name`? z `auth.user.txt`                                                      | Połącz `person.user` z `user.id`.                                                                                                                  | Wymaga łączenia. Sprawdź długość/znaki.                                                                                                                         |
| `Nazwisko`                       | `last_name`? z `auth.user.txt`                                                       | Połącz `person.user` z `user.id`.                                                                                                                  | Wymaga łączenia. Sprawdź długość/znaki.                                                                                                                         |
| `Pesel`                          | `pesel` z `gabinet.person.txt`                                                       | Mapowanie bezpośrednie.                                                                                                                            | Sprawdź format/sumę kontrolną.                                                                                                                                  |
| `Email`                          | `email`? z `auth.user.txt`                                                           | Połącz `person.user` z `user.id`.                                                                                                                  | Wymaga łączenia.                                                                                                                                                |
| `Telefon`                        | `telephone` z `gabinet.person.txt`                                                   | Mapowanie bezpośrednie. Sprawdź format/długość.                                                                                                     |                                                                                                                                                                 |
| `NPWZ`                           | `pwz` z `gabinet.person.txt`                                                         | Mapowanie bezpośrednie. Sprawdź format.                                                                                                            |                                                                                                                                                                 |
| `TytulNaukowyId`                 | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`. Wymaga mapowania `TytulNaukowyNazwa` na ID docelowe.                                                                               |                                                                                                                                                                 |
| `TytulNaukowyNazwa`              | `academic_degree` z `gabinet.person.txt`                                             | Mapowanie bezpośrednie.                                                                                                                            |                                                                                                                                                                 |
| `TypPersoneluId`                 | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`. Wymaga mapowania `TypPersoneluNFZ` lub roli źródłowej na ID docelowe.                                                              | Użyj `TypPersoneluNFZ`, jeśli mapowanie ID jest niedostępne.                                                                                                    |
| `TypPersoneluNFZ`                | `profession_code`? z `gabinet.person.txt` lub rola z `gabinet.profile.txt`?          | Zmapuj rolę/kod źródłowy na docelowy kod NFZ (1-41 z definicji).                                                                                   | Wymaga łączenia z `profile` lub użycia `profession_code`. Potrzebuje logiki mapowania.                                                                          |
| `SpecjalizacjeIds`               | ID `specialty` z `gabinet.profile.txt`? -> `gabinet.specialty.txt`?                  | Połącz `person.profile` -> `profile.specialties` -> zmapuj `specialty.id` na ID systemu docelowego? Agreguj wiele ID, oddzielonych przecinkami.        | Potrzebne złożone łączenie/mapowanie. Prawdopodobnie potrzebne ID docelowe.                                                                                     |
| `PersonelKierujacy`              | Określ na podstawie `TypPersoneluNFZ`?                                               | Ustaw na '1' dla lekarzy/odpowiednich ról, '0' w przeciwnym razie.                                                                                 | Domyślnie '1' dla lekarzy.                                                                                                                                      |
| `Konto`                          | Określ na podstawie danych źródłowych?                                               | Ustaw na '1', jeśli konto użytkownika istnieje (`auth.user.txt`?), '0' w przeciwnym razie. Domyślnie '0'.                                            |                                                                                                                                                                 |
| `KontoLogin`                     | `username`? z `auth.user.txt`                                                        | Połącz `person.user` z `user.id`.                                                                                                                  | Wymagane, jeśli `Konto` = '1'.                                                                                                                                  |
| `NieWymagajZmianyHasla`          | *Nie dotyczy*                                                                        | Ustaw na '1' (Tak).                                                                                                                                | Domyślnie nie wymagaj zmiany dla importowanych kont.                                                                                                            |
| `PracownikNiemedyczny`           | Określ na podstawie `TypPersoneluNFZ`?                                               | Ustaw na '1' dla ról niemedycznych (np. 36, 37, 38), '0' w przeciwnym razie.                                                                       |                                                                                                                                                                 |
| `SprawdzUnikalnoscPesel`         | *Nie dotyczy*                                                                        | Ustaw na '1' (Tak).                                                                                                                                | Flaga kontrolna narzędzia importu.                                                                                                                              |
| `SprawdzUnikalnoscNpwz`          | *Nie dotyczy*                                                                        | Ustaw na '1' (Tak).                                                                                                                                | Flaga kontrolna narzędzia importu.                                                                                                                              |
| `SprawdzUnikalnoscLoginu`        | *Nie dotyczy*                                                                        | Ustaw na '1' (Tak).                                                                                                                                | Flaga kontrolna narzędzia importu.                                                                                                                              |
| `ZachowajIdentyfikator`          | *Nie dotyczy*                                                                        | Ustaw na '0' (Nie).                                                                                                                                | Flaga kontrolna narzędzia importu.                                                                                                                              |
| `Usunieto`                       | `erased` z `gabinet.person.txt`                                                      | Zmapuj źródłowy boolean (`erased`) na '1' (Prawda) lub '0' (Fałsz).                                                                                |                                                                                                                                                                 |

### 5. Dla `stale_leki_pacjenta.csv` (Nowy Plik)

| Pole Docelowe                    | Pole/Plik(i) Źródłowe                                                                | Logika Transformacji                                                                                                                               | Uwagi                                                                                                                                                           |
| :------------------------------- | :----------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `InstalacjaId`                   | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`.                                                                                                                                     |                                                                                                                                                                 |
| `PacjentId`                      | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`. ID systemu docelowego.                                                                                                            | Wymaga `PacjentIdImport` lub `PacjentPesel`.                                                                                                                    |
| `PacjentIdImport`                | `patient` z `gabinet.patientpermanentdrug.txt`                                       | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub `PacjentId` / `PacjentPesel`).                                                                                                                    |
| `PacjentPesel`                   | `pesel` z `gabinet.patient.txt`                                                      | Połącz `patientpermanentdrug.patient` z `patient.id`.                                                                                              | Wymagane (lub `PacjentId` / `PacjentIdImport`).                                                                                                                 |
| `PracownikId`                    | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`. ID systemu docelowego.                                                                                                            | Źródło ID przepisującego niejasne w `patientpermanentdrug.txt`.                                                                                                |
| `PracownikIdImport`              | *Niedostępne bezpośrednio*                                                            | Określ źródło, jeśli możliwe (np. link do oryginalnej recepty?). Domyślnie `null`.                                                                  | Źródło ID przepisującego niejasne w `patientpermanentdrug.txt`. Kod powinien logować ostrzeżenie, jeśli to pole jest wymagane, a źródło jest `null`.          |
| `KodKreskowy`                    | `ean13` z `gabinet.ver.txt` przez ID `drug` LUB `composition` z `gabinet.patientpermanentdrug.txt` | Jeśli `patientpermanentdrug.drug` jest puste, użyj `patientpermanentdrug.composition`. W przeciwnym razie połącz `patientpermanentdrug.drug` z `gabinet.ver.txt` po `id`, aby uzyskać `ean13`. | **Wymagane**. Używa `composition` jako rezerwy, jeśli brakuje ID `drug`. W przeciwnym razie wymaga wyszukania `ean13`.                                         |
| `DataZalecenia`                  | *Niedostępne bezpośrednio*                                                            | Określ źródło (np. znacznik czasu utworzenia rekordu `patientpermanentdrug`?) lub domyślną (np. data importu). Zapewnij format `RRRR-MM-DD GG:MM:SS`. | Źródło niejasne w `patientpermanentdrug.txt`.                                                                                                                  |
| `DataZakonczenia`                | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Źródło niejasne w `patientpermanentdrug.txt`.                                                                                                                  |
| `Dawkowanie`                     | `recommendation` z `gabinet.patientpermanentdrug.txt`                                | Mapowanie bezpośrednie.                                                                                                                            |                                                                                                                                                                 |
| `Ilosc`                          | `dosation` z `gabinet.patientpermanentdrug.txt`                                      | Sparsuj ilość numeryczną z ciągu źródłowego (np. "2 op." -> "2").                                                                                  |                                                                                                                                                                 |
| `RodzajIlosci`                   | `dosation` z `gabinet.patientpermanentdrug.txt`                                      | Sparsuj jednostkę z ciągu źródłowego (np. "op.") i zmapuj na kod docelowy (1=opakowanie, 2=inne). Domyślnie '1' lub '2'.                             | Potrzebuje logiki mapowania dla jednostek.                                                                                                                      |
| `KodOdplatnosci`                 | `payment` z `gabinet.patientpermanentdrug.txt`                                       | Mapowanie bezpośrednie (np. "100%").                                                                                                               |                                                                                                                                                                 |

### 6. Dla `deklaracje_poz.csv` (Poprawiono)

| Pole Docelowe                    | Pole/Plik(i) Źródłowe                                                                | Logika Transformacji                                                                                                                               | Uwagi                                                                                                                                                           |
| :------------------------------- | :----------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `InstalacjaId`                   | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`.                                                                                                                                     | Zgodnie z definicją.                                                                                                                                            |
| `IdImport`                       | `id` z `gabinet.nfzdeclaration.txt`                                                  | Mapowanie bezpośrednie.                                                                                                                            | Wymagane. Klucz główny deklaracji.                                                                                                                              |
| `TypDeklaracjiPOZ`               | `type` z `gabinet.nfzdeclaration.txt`                                                | Bezpośrednie mapowanie kodów źródłowych (obserwowane L, P, O). Należy potwierdzić mapowanie dla S, C, H, jeśli istnieją w źródle.                   | Wymagane (lub `TypDeklaracjiPOZId`).                                                                                                                            |
| `TypDeklaracjiPOZId`             | *Wyprowadzone z `TypDeklaracjiPOZ`*                                                   | Zmapuj kody tekstowe (L, P, O, S, C, H) na odpowiadające im docelowe ID numeryczne, jeśli wymagane przez proces importu. W przeciwnym razie pozostaw `null`. | Wymagane (lub `TypDeklaracjiPOZ`).                                                                                                                            |
| `DataZlozenia`                   | `creation_date` z `gabinet.nfzdeclaration.txt`                                       | Mapowanie bezpośrednie. Zapewnij format `RRRR-MM-DD GG:MM:SS`. Dodaj domyślny czas '00:00:00', jeśli obecna jest tylko data.                           | Wymagane dla niektórych typów/dat zgodnie z definicją.                                                                                                         |
| `DataWygasniecia`                | `deletion_date` z `gabinet.nfzdeclaration.txt`                                       | Mapowanie bezpośrednie. Zapewnij format `RRRR-MM-DD GG:MM:SS`. Dodaj domyślny czas '00:00:00', jeśli obecna jest tylko data. Obsłuż wartości `null`. | Określa, czy deklaracja jest aktywna.                                                                                                                           |
| `JednostkaId`                    | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`.                                                                                                                                     | Wymaga `JednostkaIdImport`.                                                                                                                                     |
| `JednostkaIdImport`              | `department` z `gabinet.nfzdeclaration.txt`                                          | Mapowanie bezpośrednie po weryfikacji istnienia w `gabinet.office.txt` (Połącz `nfzdeclaration.department` = `office.department`).                  | Wymagane (lub `JednostkaId`). Jest to ID działu/gabinetu systemu zewnętrznego.                                                                                 |
| `PacjentId`                      | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`.                                                                                                                                     | Wymaga `PacjentIdImport` lub `PacjentPesel`.                                                                                                                    |
| `PacjentIdImport`                | `patient` z `gabinet.nfzdeclaration.txt`                                             | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub `PacjentId` / `PacjentPesel`).                                                                                                                    |
| `PacjentPesel`                   | `pesel` z `gabinet.patient.txt`                                                      | Połącz `gabinet.nfzdeclaration.txt` po `patient` z `gabinet.patient.txt` po `id`.                                                                  | Wymagane (lub `PacjentId` / `PacjentIdImport`).                                                                                                                 |
| `TypPacjentaId`                  | *Niedostępne bezpośrednio*                                                            | Domyślnie '1' (Pacjent z nadanym nr PESEL). Plik źródłowy nie zawiera bezpośrednich informacji.                                                     | Wymagane.                                                                                                                                                       |
| `PracownikId`                    | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`.                                                                                                                                     | Wymaga `PracownikIdImport` lub `PracownikNPWZ`.                                                                                                                 |
| `PracownikIdImport`              | `personnel` z `gabinet.nfzdeclaration.txt`                                           | Mapowanie bezpośrednie.                                                                                                                            | Wymagane (lub `PracownikId` / `PracownikNPWZ` dla niektórych typów/dat).                                                                                         |
| `PracownikNPWZ`                  | `pwz` z `gabinet.person.txt`                                                         | Połącz `gabinet.nfzdeclaration.txt` po `personnel` z `gabinet.person.txt` po `id`.                                                                 | Wymagane (lub `PracownikId` / `PracownikIdImport` dla niektórych typów/dat).                                                                                     |
| `PeselOpiekuna`                  | `pesel` z `gabinet.custodian.txt`                                                    | Połącz `nfzdeclaration.patient` -> `patient.id` -> `patient.supervisor` -> `custodian.id` -> `custodian.pesel`. Obsłuż wielu opiekunów, jeśli potrzebne. | Powiązanie źródłowe złożone i potencjalnie brakujące. Domyślnie `null`. Kod powinien logować ostrzeżenie w przypadku nieznalezienia opiekuna.                 |
| `PeselOpiekuna2`                 | `pesel` z `gabinet.custodian.txt`                                                    | Podobna logika łączenia jak `PeselOpiekuna` dla drugiego opiekuna, jeśli dotyczy.                                                                   | Powiązanie źródłowe złożone i potencjalnie brakujące. Domyślnie `null`. Kod powinien logować ostrzeżenie w przypadku nieznalezienia drugiego opiekuna.        |
| `KodTypuPodopiecznego`           | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Dane źródłowe nieobecne w `nfzdeclaration.txt`.                                                                                                               |
| `TypSzkolyId`                    | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `KodRodzajuSzkoly`               | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `NazwaSzkoly`                    | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `PatronSzkoly`                   | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `RegonSzkoly`                    | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `UlicaSzkoly`                    | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `KodPocztowySzkoly`              | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `KodGminySzkoly`                 | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `MiejscowoscSzkoly`              | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `NrDomuSzkoly`                   | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `NrTelefonuSzkoly`               | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Istotne dla `TypDeklaracjiPOZ` = 'S'. Dane źródłowe nieobecne.                                                                                                  |
| `NrUmowyUbezpieczeniowej`        | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Dane źródłowe nieobecne.                                                                                                                                        |
| `NIP`                            | *Niedostępne bezpośrednio*                                                            | Domyślnie `null`.                                                                                                                                    | Dane źródłowe nieobecne.                                                                                                                                        |
| `ProfilaktykaFluorkowa`          | *Niedostępne bezpośrednio*                                                            | Domyślnie '0'.                                                                                                                                       | Dane źródłowe nieobecne.                                                                                                                                        |
| `Komentarz`                      | `note` z `gabinet.nfzdeclaration.txt`                                                | Mapowanie bezpośrednie. Obetnij do 255 znaków, jeśli konieczne.                                                                                    | Maks. długość 255 (Ostrzeżenie).                                                                                                                                |

### 7. Dla `jednostki.csv` (Nowy Plik - Definicja do potwierdzenia)

| Pole Docelowe                    | Pole/Plik(i) Źródłowe                                                                | Logika Transformacji                                                                                                                               | Uwagi                                                                                                                                                           |
| :------------------------------- | :----------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `IdImport`                       | `department` z `gabinet.office.txt`                                                  | Mapowanie bezpośrednie. Użyj ID `department` jako głównego klucza importu dla jednostki.                                                           | Wymagane. Wydaje się być spójnym zewnętrznym ID dla jednostki/działu w różnych plikach.                                                                        |
| `Nazwa`                          | `name` z `gabinet.office.txt`                                                        | Mapowanie bezpośrednie.                                                                                                                            | Wymagane. Nazwa gabinetu/jednostki.                                                                                                                             |
| `Aktywna`                        | `active` z `gabinet.office.txt`                                                      | Zmapuj boolean (`True`/`False`) na '1'/'0' lub 'T'/'N' w zależności od wymagań systemu docelowego.                                                 | Definicja potrzebna dla formatu docelowego.                                                                                                                     |
| `IdWewnetrzny`?                  | `id` z `gabinet.office.txt`?                                                         | Zmapuj to, jeśli wewnętrzne ID źródła (`office.id`) jest potrzebne do referencji w systemie docelowym.                                            | Definicja potrzebna. Jest to wewnętrzny klucz główny źródła dla rekordu gabinetu.                                                                               |

### 8. Dla `dokumenty_uprawniajace.csv` (Nowy Plik)

| Pole Docelowe                    | Pole/Plik(i) Źródłowe                                                                 | Logika Transformacji                                                                                                                                                                                                                            | Uwagi                                                                                                                                                                                                                                                           |
| :------------------------------- | :------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `InstalacjaId`                   | *Niedostępne bezpośrednio*                                                             | Ustaw na `null`.                                                                                                                                                                                                                                | Zgodnie z definicją.                                                                                                                                                                                                                                            |
| `IdImport`                       | `id` z `gabinet.insurancedocuments.txt`                                                 | Mapowanie bezpośrednie.                                                                                                                                                                                                                         | Wymagane. Klucz główny dokumentu.                                                                                                                                                                                                                               |
| `KodDokumentu`                   | `document_name` z `gabinet.insurancedocuments.txt`                                      | Bezpośrednie mapowanie. W przyszłości może wymagać mapowania na predefiniowane kody, jeśli wartości źródłowe nie będą pasować.                                                                                                                | Wymagane.                                                                                                                                                                                                                                                       |
| `KodUprawnienia`                 | `permissions_title` z `gabinet.insurance.txt` (połączone przez `insurancedocuments.insurance` = `insurance.id`) | Połącz `gabinet.insurancedocuments.txt` z `gabinet.insurance.txt`. W przyszłości może wymagać mapowania na predefiniowane kody.                                                                                                      | Wymagane.                                                                                                                                                                                                                                                       |
| `NazwaDokumentu`                 | `document_name` z `gabinet.insurancedocuments.txt`                                      | Mapowanie bezpośrednie.                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                 |
| `PacjentId`                      | *Niedostępne bezpośrednio*                                                             | Ustaw na `null`.                                                                                                                                                                                                                                | Wymaga `PacjentIdImport` lub `PacjentPesel`.                                                                                                                                                                                                                    |
| `PacjentIdImport`                | `patient` z `gabinet.insurance.txt` (połączone przez `insurancedocuments.insurance` = `insurance.id`) | Połącz `gabinet.insurancedocuments.txt` z `gabinet.insurance.txt`.                                                                                                                                                              | Wymagane (lub `PacjentId` / `PacjentPesel`).                                                                                                                                                                                                                    |
| `PacjentPesel`                   | `pesel` z `gabinet.patient.txt` (połączone przez `insurance.patient` = `patient.id`)      | Połącz `gabinet.insurancedocuments.txt` -> `gabinet.insurance.txt` -> `gabinet.patient.txt`.                                                                                                                                                  | Wymagane (lub `PacjentId` / `PacjentIdImport`).                                                                                                                                                                                                                    |
| `KodOddzialuNFZ`                 | `id_nfz` z `gabinet.insurance.txt` (połączone przez `insurancedocuments.insurance` = `insurance.id`) | Połącz `gabinet.insurancedocuments.txt` z `gabinet.insurance.txt`.                                                                                                                                                              |                                                                                                                                                                                                                                                                 |
| `NIP`                            | `nip` z `gabinet.insurancedocuments.txt`                                                | Mapowanie bezpośrednie.                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                 |
| `DataOd`                         | `valid_from` z `gabinet.insurancedocuments.txt`                                         | Mapowanie bezpośrednie. Zapewnij format `RRRR-MM-DD GG:MM:SS` (dodaj domyślny czas '00:00:00', jeśli tylko data).                                                                                                                              |                                                                                                                                                                                                                                                                 |
| `DataDo`                         | `valid_to` z `gabinet.insurancedocuments.txt` (jeśli istnieje)                          | Mapowanie bezpośrednie. Zapewnij format `RRRR-MM-DD GG:MM:SS` (dodaj domyślny czas '00:00:00', jeśli tylko data).                                                                                                                              | Pole `valid_to` może nie istnieć we wszystkich rekordach `insurancedocuments.txt`.                                                                                                                                                                            |
| `DataWystawienia`                | `set_date` z `gabinet.insurancedocuments.txt`                                           | Mapowanie bezpośrednie. Zapewnij format `RRRR-MM-DD GG:MM:SS` (dodaj domyślny czas '00:00:00', jeśli tylko data). Alternatywnie `receive_date`.                                                                                                 |                                                                                                                                                                                                                                                                 |
| `KodInstytucjiWystawiajacej`     | `competent_institution` z `gabinet.insurancedocuments.txt`                              | Mapowanie bezpośrednie. Alternatywnie `issuer`.                                                                                                                                                                                                 |                                                                                                                                                                                                                                                                 |
| `NazwaInstytucjiWystawiajacej`   | `issuing_authority` z `gabinet.insurancedocuments.txt`                                  | Mapowanie bezpośrednie. Alternatywnie `issuer`.                                                                                                                                                                                                 |                                                                                                                                                                                                                                                                 |
| `Numer`                          | `document_number` z `gabinet.insurancedocuments.txt`                                    | Mapowanie bezpośrednie.                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                 |
| `TypOswiadczenia`                | *Niedostępne bezpośrednio*                                                            | Domyślnie `DEFAULT_EMPTY`. Wymaga analizy, czy to pole jest generowane na podstawie innych danych.                                                                                                                                             |                                                                                                                                                                                                                                                                 |
| `PodstawaOswiadczenia`           | `permission_basis` z `gabinet.insurancedocuments.txt`                                   | Mapowanie bezpośrednie.                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                 |
| `PeselOpiekuna`                  | *Niedostępne bezpośrednio*                                                            | Domyślnie `DEFAULT_EMPTY`. Wymaga analizy, czy to pole jest generowane na podstawie innych danych.                                                                                                                                             |                                                                                                                                                                                                                                                                 |
| `RodzajZezwoleniaLubOchrony`     | `permission_type` z `gabinet.insurancedocuments.txt`                                    | Mapowanie bezpośrednie.                                                                                                                                                                                                                         |                                                                                                                                                                                                                                                                 |
| `InstytucjaWystawiajaca`         | *Niedostępne bezpośrednio*                                                            | Ustaw na `null`.                                                                                                                                                                                                                                | Zgodnie z definicją.                                                                                                                                                                                                                                            |
| `EwusId`                         | *Niedostępne bezpośrednio*                                                            | Domyślnie `DEFAULT_EMPTY`. Wymaga analizy, czy to pole jest generowane na podstawie innych danych (np. jeśli `KodDokumentu` = 'EL').                                                                                                            |                                                                                                                                                                                                                                                                 |
### 9. Dla `szczepienia.csv` (Nowy Plik)

| Pole Docelowe | Pole/Plik(i) Źródłowe | Logika Transformacji | Uwagi |
| :--- | :--- | :--- | :--- |
| `InstalacjaId` | *Niedostępne bezpośrednio* | Ustaw na `null`. | Zgodnie z definicją. |
| `IdImport` | `id` z `gabinet.vaccination.txt` | Mapowanie bezpośrednie. | Wymagane. Klucz główny szczepienia. |
| `PacjentIdImport` | `patient` z `gabinet.vaccination.txt` | Mapowanie bezpośrednie. | Wymagane (lub `PacjentPesel`). |
| `PacjentPesel` | `pesel` z `gabinet.patient.txt` | Połącz `vaccination.patient` z `patient.id`. | Wymagane (lub `PacjentIdImport`). |
| `PracownikIdImport`| `vaccinator` lub `person` z `gabinet.vaccination.txt` | Użyj `vaccinator`, jeśli dostępne, w przeciwnym razie `person`. | Identyfikator pracownika wykonującego lub zlecającego. |
| `PracownikNPWZ` | `pwz` z `gabinet.person.txt` | Połącz po `PracownikIdImport` z `person.id`. | Wymagane (lub inne identyfikatory). |
| `PracownikPesel` | `pesel` z `gabinet.person.txt` | Połącz po `PracownikIdImport` z `person.id`. | Wymagane (lub inne identyfikatory). |
| `Nazwa` | `drug` z `gabinet.vaccination.txt` | Mapowanie bezpośrednie. | Nazwa handlowa lub opis szczepionki. |
| `MiejscePodania` | `vaccination_site` z `gabinet.vaccination.txt` | Mapowanie bezpośrednie. | |
| `NrSerii` | `vaccine_series` z `gabinet.vaccination.txt` | Mapowanie bezpośrednie. | |
| `DataPodania` | `datetime` z `gabinet.vaccination.txt` | Mapowanie bezpośrednie. Zapewnij format `RRRR-MM-DD GG:MM:SS`. | Wymagane. |
| `DataWaznosci` | `expiration_date` z `gabinet.vaccination.txt` | Mapowanie bezpośrednie. Zapewnij format `RRRR-MM-DD GG:MM:SS`. | Opcjonalne. |
| `DrogaPodaniaId` | `vaccination_area` z `gabinet.vaccination.txt` | Wymaga mapowania wartości tekstowej (np. "Iniekcja domięśniowa") na ID numeryczne. Domyślnie `null`. | Wymaga słownika mapującego. |
| `CzyZKalendarza` | `vaccination_kind` z `gabinet.vaccination.txt` | Zmapuj "Z kalendarza szczepień" na '1', w przeciwnym razie '0'. | |
| `SzczepienieId` | *Niedostępne bezpośrednio* | Wymaga mapowania `drug` na ID ze słownika docelowego. Domyślnie `null`. | Wymagane. Wymaga słownika mapującego. |
| `Dawka` | `dose` lub `number_of_dose` z `gabinet.vaccination.txt` | Użyj `dose`, jeśli dostępne, w przeciwnym razie `number_of_dose`. | Wymagane, jeśli `CzyZKalendarza` = '1'. |

## Pliki Źródłowe w `src` (Referencja)

Poniżej znajduje się lista plików znajdujących się w katalogu `src` w momencie tworzenia tej wersji planu (V4):

*   `converter.py`
*   `etap2.ps1`
*   `etap3_validator.py`
*   `medConverter.py`
*   `selector.ps1`
*   `xml2json.jar`

## Kluczowe Rozważania i Walidacja (Aktualizacja V4)

*   **Separator CSV:** Wyjściowe pliki CSV używają średnika (`;`). Zapewnij poprawne eskejpowanie średników w polach danych.
*   **Kodowanie Znaków:** Zakładaj UTF-8 dla wejścia i wyjścia, chyba że określono inaczej.
*   **Mapowanie ID:** Konsekwentnie używaj ID systemu źródłowego (pola `IdImport`). ID systemu docelowego (`PacjentId`, `PracownikId` itp.) wymagają mapowania po imporcie lub oddzielnych tabel wyszukiwania. `InstalacjaId` jest zazwyczaj puste.
*   **Wymagane Pola i Walidacja:** Ściśle przestrzegaj reguł walidacji w definicjach (np. wymagane identyfikatory dla wizyt, pacjentów, pracowników; formaty dat; listy kodów; długości pól). Implementuj kontrole i obsługuj błędy/ostrzeżenia odpowiednio (np. pomiń rekord, zapisz ostrzeżenie).
*   **Typy Danych:** Upewnij się, że dane odpowiadają typom docelowym (Liczba całkowita, Tekst, Data i czas, Tak/Nie, Znak). Wykonaj niezbędne konwersje (np. ciąg znaków na liczbę całkowitą, formatowanie daty, boolean na '1'/'0'). Zwróć uwagę, że `karty_wizyt.IdImport` to Tekst.
*   **Mapowanie Kodów:** Implementuj solidne mapowanie dla pól wyliczeniowych (`Status`, `TrybPrzyjecia`, `Plec`, `UprawnieniePacjentaId`, `TypPersoneluNFZ`, `StopienPokrewienstwaOpiekuna` itp.) z wartości źródłowych na kody docelowe. Obsługuj nieznane wartości źródłowe z gracją (np. domyślna, ostrzeżenie). **Kluczowe jest logowanie wszystkich napotkanych nieznanych wartości źródłowych podczas mapowania kodów (nie tylko statusu wizyty), aby umożliwić weryfikację kompletności mapowań i ich ewentualne uzupełnienie.**
*   **Łączenia (Joins):** Proces wymaga wielu łączeń między plikami `etap1`. Obsługuj potencjalne brakujące powiązania (np. pacjent bez adresu, wizyta bez rozpoznanego lekarza, deklaracja bez gabinetu) używając odpowiednich typów łączeń (np. LEFT JOIN) i wartości domyślnych. Kluczowe łączenia obejmują:
    *   Wizyta -> Pacjent, Lekarz/Osoba, Gabinet
    *   Pacjent -> Adres (Zameldowania/Zamieszkania), Opiekun
    *   Osoba -> Użytkownik (dla nazwy/loginu), Profil (dla roli/specjalizacji)
    *   Stały Lek -> Pacjent, Słownik Leków
    *   Deklaracja NFZ -> Pacjent, Personel/Osoba, Gabinet (przez pole `department`)
*   **Pola Tekstowe:** Obsługuj potencjalnie długie pola tekstowe (`Wywiad`, `BadaniePrzedmiotowe`, `Zalecenia`, `Komentarz`, `Uwagi`), upewniając się, że nie przekraczają limitów ani nie łamią struktury CSV (np. obsłuż znaki nowej linii).
*   **Mapowanie Adresów:** Starannie zmapuj powiązania `registration_address` i `residence_address` z `patient.txt` do `address.txt`, aby wypełnić odpowiednio pola `...Zameldowanie` i `...Zamieszkanie`. Obsłuż brakujące adresy. Zwróć uwagę na brakujące kody TERYT/Powiat.
*   **Mapowanie Opiekuna:** Połącz `patient.supervisor` z `custodian.id`. Zmapuj tekst relacji na ID. Dane adresowe opiekuna wydają się niedostępne. Obsłuż potencjalnie wielu opiekunów na pacjenta, jeśli to konieczne.
*   **Mapowanie Leków:** Zmapuj `patientpermanentdrug.drug` (ID) na `KodKreskowy` (EAN) używając `gabinet.ver.txt` (połącz po `id`, pobierz `ean13`). Obsłuż przypadki, gdy ID leku może nie zostać znalezione w `gabinet.ver.txt` lub `ean13` jest puste. Użyj `patientpermanentdrug.composition` jako rezerwy, jeśli `drug` ID jest puste.
*   **Mapowanie Statusu Wizyty:** Zmapuj znane statusy źródłowe (np. "Archiwalna" -> '3'). Implementuj logikę do zbierania i raportowania wszystkich unikalnych wartości `state` źródła napotkanych podczas przetwarzania, aby umożliwić późniejsze kompletne mapowanie.
*   **Brakujące Dane Źródłowe:** Zidentyfikuj pola bez wyraźnych źródeł (np. `TrybDalszegoLeczenia`, `TypWizyty`, `DataZalecenia` dla stałych leków, większość pól `deklaracje_poz.csv`) i ustal zasady dla wartości domyślnych na podstawie definicji.

## Podsumowanie Zmian od V5 (Ta Aktualizacja - V6)

1.  **Nowy Plik Docelowy:** Dodano specyfikację mapowania dla `deklaracje_poz.csv` na podstawie `definitions/deklaracje_poz.csv` i analizy `etap1/gabinet.nfzdeclaration.txt`. *(Przeniesione z V4)*
2.  **Nowy Plik Docelowy:** Dodano proponowaną specyfikację mapowania dla `jednostki.csv` na podstawie analizy `etap1/gabinet.office.txt` i żądania użytkownika (definicja do potwierdzenia). Dostosowano `IdImport` do użycia pola `department`. *(Przeniesione z V4)*
3.  **Poprawione Mapowanie `deklaracje_poz.csv`:** Zaktualizowano mapowanie `JednostkaIdImport` do bezpośredniego użycia pola `department`, zgodnie z wyjaśnieniem użytkownika. *(Przeniesione z V4)*
4.  **Zaktualizowane Łączenia:** Dodano wymagania dotyczące łączenia Deklaracji NFZ do Kluczowych Rozważań, wyjaśniając łączenie po `department`. *(Przeniesione z V4)*
5.  **Zaktualizowane Braki:** Odnotowano brakujące dane źródłowe dla wielu pól `deklaracje_poz.csv`. *(Przeniesione z V4)*
6.  **Wersja:** Zaktualizowano wersję planu do V6.
7.  **Język:** Przetłumaczono dokument na język polski. *(Przeniesione z V4)*
8.  **Pliki Źródłowe:** Zaktualizowano listę plików w katalogu `src`, uwzględniając dodanie `etap3_validator.py`. *(Przeniesione z V5)*
9.  **Synchronizacja z Kodem:** Zaktualizowano logikę transformacji, wartości domyślne, obsługę błędów i nazwy pól w całym dokumencie, aby dokładnie odzwierciedlały implementację w `src/converter.py`. Zaznaczono mapowania wymagające implementacji w kodzie (placeholdery). Doprecyzowano logikę fallbacków i walidacji. Zaktualizowano sekcję "Kluczowe Rozważania". *(Przeniesione z V5)*
10. **Nowy Plik Docelowy:** Dodano specyfikację mapowania dla `dokumenty_uprawniajace.csv` na podstawie `definitions/dokumenty_uprawniajace.csv` oraz analizy plików `etap1/gabinet.insurance.txt` i `etap1/gabinet.insurancedocuments.txt`.
11. **Zaktualizowany Diagram Przepływu Danych:** Dodano `gabinet.insurancedocuments.txt` do plików źródłowych oraz `dokumenty_uprawniajace.csv` do plików docelowych.
12. **Nowy Plik Docelowy:** Dodano specyfikację mapowania dla `szczepienia.csv` na podstawie `definitions/szczepienia.csv` oraz analizy przykładowego pliku `baza_plikimigracyjne/gabinet.vaccination.csv`.
13. **Zaktualizowany Diagram Przepływu Danych:** Dodano `gabinet.vaccination.txt` do plików źródłowych oraz `szczepienia.csv` do plików docelowych.
14. **Reorganizacja Pól Karty Wizyty:** Przeniesiono informacje o lekach z `visit.note` z pola `Inne` do pola `Zalecenia`, aby skonsolidować wszystkie zalecenia w jednym miejscu. Pole `Inne` zawiera teraz wyłącznie notatki z `visitnotes.txt`.
15. **Usprawnienie Wyszukiwania Nazw Leków:** Poprawiono logikę wyszukiwania nazw leków w `gabinet.ver.txt`, aby używała poprawnej kolumny (`name_text`) i ładowała wszystkie wymagane kolumny (`id`, `name_text`, `ean13`), co rozwiązało problem brakujących nazw leków.
16. **Usunięcie Przetwarzania Skierowań:** Usunięto całą logikę związaną z przetwarzaniem pliku `gabinet.nfzservicereportserviceset.txt`. Uznano, że identyfikatory skierowań bez dodatkowego opisu nie wnoszą wartościowej informacji do pola `PrzebiegLeczenia`.